#!/usr/bin/perl
#
########################################################################################################################
########################################################################################################################
##
##      Copyright (C) 2021 Peter Walsh, Milford, NH 03055
##      All Rights Reserved under the MIT license as outlined below.
##
##  FILE
##
##      MakeDataJS
##
##  DESCRIPTION
##
##      Read the Motivator Project directory, and create Project.js for inclusion into the web page.
##
##      Javascript has no ability to list the files within directories, so we use this program to
##        do that and generate a javascript file that explicitly contains the needed links.
##
##  USAGE
##
##      MakeProjectJS
##
##      Scans the Projects directory, and creates the file "Project.js" in the web directory.
##
########################################################################################################################
########################################################################################################################
##
##  MIT LICENSE
##
##  Permission is hereby granted, free of charge, to any person obtaining a copy of
##    this software and associated documentation files (the "Software"), to deal in
##    the Software without restriction, including without limitation the rights to
##    use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
##    of the Software, and to permit persons to whom the Software is furnished to do
##    so, subject to the following conditions:
##
##  The above copyright notice and this permission notice shall be included in
##    all copies or substantial portions of the Software.
##
##  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
##    INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
##    PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
##    HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
##    OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
##    SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
##
########################################################################################################################
########################################################################################################################

use strict;
use warnings;
use Carp;

use File::Slurp;

########################################################################################################################
########################################################################################################################
##
## Data declarations
##
########################################################################################################################
########################################################################################################################

my $JSFile      = "Projects.js";
my $WordsFile   = "Words.txt";
my $MetaFile    = "Meta.txt";

my %Projects;           # The database of projects

my $Header = <<'END_HEADER';
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Projects.js - Project database
//
// Copyright (C) 2020 Peter Walsh, Milford, NH 03055
// All Rights Reserved under the MIT license as outlined below.
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// DO NOT EDIT THIS FILE!
//
// This file is automatically generated by the "MakeProjectsJS" command. Any changes made here will be
//   lost the next time that command is run.
//
// To add/remove/change images, make the appropriate changes to the specific category directory, then 
//   run MakeProjectsJS to recreate this file. Similarly to add/remove/change words in any Words.txt
//   file within any category directory.
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//  MIT LICENSE
//
//  Permission is hereby granted, free of charge, to any person obtaining a copy of
//    this software and associated documentation files (the "Software"), to deal in
//    the Software without restriction, including without limitation the rights to
//    use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
//    of the Software, and to permit persons to whom the Software is furnished to do
//    so, subject to the following conditions:
//
//  The above copyright notice and this permission notice shall be included in
//    all copies or substantial portions of the Software.
//
//  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
//    INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
//    PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
//    HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
//    OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
//    SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

END_HEADER

########################################################################################################################
########################################################################################################################
##
## MakeProjectsJS
##
########################################################################################################################
########################################################################################################################

#
# If there's a Projects dir in the current directory, then we work from here.
#
die "Cannot find 'Projects' directory."
    unless -d "Projects";

chdir "Projects";

foreach my $Category (<*>) {

    next
        unless -d $Category;

    AddCategory($Category);
    }

chdir "..";

WriteProjectsJS();

print "Done. $JSFile written to current directory\n";

exit(0);


########################################################################################################################
########################################################################################################################
#
# AddCategory - Add a new project category to the growing database
#
# Inputs:   Name of category to add
#
# Outputs:  None.
#
sub AddCategory {
    my $Category = shift;

    $Projects{$Category}{ Words} = [];
    $Projects{$Category}{Images} = [];
    $Projects{$Category}{  Meta} = [];

    die "No category dir found for $Category"
        unless -d $Category;

    chdir $Category;

    ####################################################################################################################

    my @Images = <*.jpg *.jpeg *.gif *.png *.bmp>;

    die "No images found for project $Category"
        unless scalar @Images;

    push @{$Projects{$Category}{Images}},$_
        foreach @Images;

    ####################################################################################################################

    die "No $WordsFile file found for $Category"
        unless -e $WordsFile;

    my @Words = read_file($WordsFile, { chomp => 1 });

#    die "No words found for project $Category"
#        unless scalar @Words;

    push @{$Projects{$Category}{Words}},$_
        foreach @Words;

    ####################################################################################################################

    die "No $MetaFile file found for $Category"
        unless -e $MetaFile;

    my @Meta = read_file($MetaFile, { chomp => 1 });

     die "No meta info found for project $Category"
         unless scalar @Meta;

    push @{$Projects{$Category}{Meta}},$_
        foreach @Meta;

    chdir "..";
    }


########################################################################################################################
########################################################################################################################
#
# WriteProjectsJS - Write the "Projects.js" file from our collected list of project info
#
# Inputs:   None.
#
# Outputs:  None.
#
sub WriteProjectsJS {

    open(JS, '>', $JSFile)
        or die "Cannot write $JSFile ($!).";

    print JS $Header;

    print JS "var Projects = {\n";
#    print JS "    Vers: " . time() . ",\n";

    foreach my $Category (sort keys %Projects) {
        print JS "    $Category: {\n";

        print JS "        Meta: {\n";
        print JS "            $_\n"
            foreach @{$Projects{$Category}{Meta}};
        print JS "            },\n";

        print JS "        Words: [\n";
        print JS "            '" . EscapeWord($_) . "',\n"
            foreach @{$Projects{$Category}{Words}};
        print JS "            ],\n";

        print JS "        Images: [\n";
        print JS "            'Projects/$Category/$_',\n"
            foreach @{$Projects{$Category}{Images}};
        print JS "            ]\n";

        print JS "    },\n";
        }

    print JS "};\n";

    close JS;
    }


########################################################################################################################
########################################################################################################################
#
# EscapeWord - Escape any problematic chars in a word (such as quote or double quotes)
#
# Inputs:   Word to escape
#
# Outputs:  Standard word.
#
sub EscapeWord {
    my $Word = shift;

    $Word =~ s/\"/\\\"/g;
    $Word =~ s/\'/\\\'/g;

    return $Word;
    }
